<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleveleys Morrisons Management Dashboard</title>
    <!-- Load Google Charts Loader -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        header {
            background-color: #2c3e50;
            color: #fff;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 {
            margin: 0;
            font-size: 2em;
        }
        .nav {
            background-color: #34495e;
            overflow: hidden;
        }
        .nav a {
            float: left;
            display: block;
            color: #ecf0f1;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
        }
        .nav a:hover {
            background-color: #2c3e50;
        }
        .container {
            padding: 20px;
        }
        section {
            margin-bottom: 40px;
        }
        section h2 {
            background-color: #ecf0f1;
            padding: 10px;
            border-left: 5px solid #3498db;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #3498db;
            color: #fff;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .iframe-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Loading Indicator Styles */
        .loader {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #555;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            th, td {
                padding: 8px;
            }
            header h1 {
                font-size: 1.5em;
            }
            section h2 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Cleveleys Morrisons Management Dashboard</h1>
    </header>
    <div class="nav">
        <a href="#daily-tasks">Daily Tasks</a>
        <a href="#weekly-tasks">Weekly Tasks</a>
        <a href="#one-time-tasks">One-Time Tasks</a>
        <a href="#important-links">Important Links</a>
        <a href="#who-is-in">Who Is In Today?</a>
    </div>
    <div class="container">
        <!-- Daily Tasks Section -->
        <section id="daily-tasks">
            <h2>Daily Tasks</h2>
            <div id="daily-tasks-loader" class="loader">Loading Daily Tasks...</div>
            <table id="daily-tasks-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Task Name</th>
                        <th>Description</th>
                        <th>Link</th>
                        <th>Confirmation</th>
                        <th>Category</th>
                        <th>Frequency</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic Content -->
                </tbody>
            </table>
        </section>

        <!-- Weekly Tasks Section -->
        <section id="weekly-tasks">
            <h2>Weekly Tasks</h2>
            <div id="weekly-tasks-loader" class="loader">Loading Weekly Tasks...</div>
            <table id="weekly-tasks-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Day</th>
                        <th>Task Name</th>
                        <th>Description</th>
                        <th>Link</th>
                        <th>Confirmation</th>
                        <th>Category</th>
                        <th>Frequency</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic Content -->
                </tbody>
            </table>
        </section>

        <!-- One-Time Tasks Section -->
        <section id="one-time-tasks">
            <h2>One-Time Tasks</h2>
            <div id="one-time-tasks-loader" class="loader">Loading One-Time Tasks...</div>
            <table id="one-time-tasks-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Date</th>
                        <th>Task Name</th>
                        <th>Description</th>
                        <th>Link</th>
                        <th>Confirmation</th>
                        <th>Category</th>
                        <th>Frequency</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic Content -->
                </tbody>
            </table>
        </section>

        <!-- Important Links Section -->
        <section id="important-links">
            <h2>Important Links</h2>
            <div class="iframe-container">
                <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSeh199Vpaq4u_Ouy0pJBZz5sY_y_1lN9t0kJZDO9zJiuA7SpA/viewform?embedded=true" title="Super Sunday Form"></iframe>
            </div>
            <div class="iframe-container">
                <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScwD-B79hghaF3XhZnGB12ThrGnXQUJ0kseCTVzV6oFMSUo5Q/viewform?embedded=true" title="Cage Count Form"></iframe>
            </div>
            <div class="iframe-container">
                <iframe src="https://forms.gle/p8zWWWht2UYGQ3Dq8?embedded=true" title="Vocovo Covers Form"></iframe>
            </div>
            <!-- Add more embedded forms or links as needed -->
        </section>

        <!-- Who Is In Today Section -->
        <section id="who-is-in">
            <h2>Who Is In Today?</h2>
            <div class="iframe-container">
                <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vT_y-07M_h42TtOYaixA3J-8DNM9ifSLpQX2oASHEvSuzij4AtP_HwAX0TRwRX8hfcTSP-EJKiuNko6/pubhtml?gid=1881177460&single=true" title="Who Is In Today"></iframe>
            </div>
        </section>
    </div>

    <script type="text/javascript">
        // Load the Visualization API and the corechart package.
        google.charts.load('current', { 'packages': ['corechart'] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(fetchAndRenderTasks);

        function fetchAndRenderTasks() {
            // Replace the following Spreadsheet ID and Sheet Name with your own
            const spreadsheetID = '2PACX-1vSaljCQUWWn1qu09FpHG6awwY93McN4h619l-lzPhH2fkz4dPrwz7i3AvrUL8wHxSwNyg2ucps8hAVJ';
            const sheetName = 'Sheet1'; // Change if your sheet has a different name

            // Construct the query URL
            const query = new google.visualization.Query(`https://docs.google.com/spreadsheets/d/${spreadsheetID}/gviz/tq?sheet=${sheetName}&headers=1`);

            // Send the query with a callback function
            query.send(handleQueryResponse);
        }

        function handleQueryResponse(response) {
            if (response.isError()) {
                console.error('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                displayError();
                return;
            }

            const data = response.getDataTable();
            const dataArray = [];

            // Convert DataTable to Array of Objects
            for (let i = 0; i < data.getNumberOfRows(); i++) {
                const row = {};
                for (let j = 0; j < data.getNumberOfColumns(); j++) {
                    const columnName = data.getColumnLabel(j);
                    row[columnName] = data.getValue(i, j);
                }
                dataArray.push(row);
            }

            // Categorize and Render Tasks
            categorizeAndRenderTasks(dataArray);
        }

        // Function to categorize tasks and render tables
        function categorizeAndRenderTasks(data) {
            const dailyTasks = [];
            const weeklyTasks = [];
            const oneTimeTasks = [];

            data.forEach(row => {
                const frequency = row['Frequency'] ? row['Frequency'].trim().toLowerCase() : '';
                const isActive = row['Active'] ? row['Active'].trim().toLowerCase() === 'yes' : false;

                if (!isActive) {
                    // Skip inactive tasks
                    return;
                }

                if (frequency === 'daily') {
                    dailyTasks.push(row);
                } else if (frequency === 'weekly') {
                    weeklyTasks.push(row);
                } else if (frequency === 'once') {
                    oneTimeTasks.push(row);
                }
            });

            // Render Daily Tasks
            renderTable('daily-tasks-table', dailyTasks, 'daily-tasks-loader', 'daily');

            // Render Weekly Tasks
            renderTable('weekly-tasks-table', weeklyTasks, 'weekly-tasks-loader', 'weekly');

            // Render One-Time Tasks
            renderTable('one-time-tasks-table', oneTimeTasks, 'one-time-tasks-loader', 'once');
        }

        // Function to render a specific table
        function renderTable(tableId, tasks, loaderId, frequencyType) {
            const table = document.getElementById(tableId);
            const loader = document.getElementById(loaderId);
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = ''; // Clear existing content

            if (tasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8">No tasks available.</td></tr>`;
            } else {
                tasks.forEach(task => {
                    const tr = document.createElement('tr');

                    // Extract necessary fields with proper fallback
                    const time = task['Time'] ? task['Time'].trim() : 'N/A';
                    const date = task['Date'] ? task['Date'].trim() : 'N/A';
                    const dayOfWeek = task['Day of Week'] ? task['Day of Week'].trim() : 'N/A';
                    const title = task['Title'] ? task['Title'].trim() : 'N/A';
                    const description = task['Message'] ? task['Message'].trim().replace(/\n/g, '<br>') : 'N/A';
                    const link = task['Attach/Link'] ? `<a href="${task['Attach/Link']}" target="_blank">View</a>` : 'N/A';
                    const confirmStatus = formatConfirmation(task['Confirm Status']);
                    const category = task['Chat Name'] ? task['Chat Name'].trim() : 'N/A';
                    const frequency = task['Frequency'] ? task['Frequency'].trim() : 'N/A';

                    if (frequencyType === 'weekly') {
                        tr.innerHTML = `
                            <td>${time}</td>
                            <td>${dayOfWeek}</td>
                            <td>${title}</td>
                            <td>${description}</td>
                            <td>${link}</td>
                            <td>${confirmStatus}</td>
                            <td>${category}</td>
                            <td>${capitalizeFirstLetter(frequency)}</td>
                        `;
                    } else if (frequencyType === 'daily') {
                        tr.innerHTML = `
                            <td>${time}</td>
                            <td>${title}</td>
                            <td>${description}</td>
                            <td>${link}</td>
                            <td>${confirmStatus}</td>
                            <td>${category}</td>
                            <td>${capitalizeFirstLetter(frequency)}</td>
                        `;
                    } else if (frequencyType === 'once') {
                        tr.innerHTML = `
                            <td>${time}</td>
                            <td>${date}</td>
                            <td>${title}</td>
                            <td>${description}</td>
                            <td>${link}</td>
                            <td>${confirmStatus}</td>
                            <td>${category}</td>
                            <td>${capitalizeFirstLetter(frequency)}</td>
                        `;
                    }

                    tbody.appendChild(tr);
                });
            }

            // Hide loader and show table
            loader.style.display = 'none';
            table.style.display = 'table';
        }

        // Function to format confirmation column
        function formatConfirmation(confirmation) {
            if (!confirmation || confirmation.toLowerCase() === 'no') {
                return 'No';
            }
            // Attempt to extract email and timestamp
            const emailMatch = confirmation.match(/Confirmed by (.+?) at/);
            const timeMatch = confirmation.match(/at (.+)/);
            const email = emailMatch ? `<a href="mailto:${emailMatch[1]}">${emailMatch[1]}</a>` : 'N/A';
            const time = timeMatch ? timeMatch[1] : 'N/A';
            return `Yes (Confirmed by ${email} at ${time})`;
        }

        // Function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Function to display error messages
        function displayError() {
            const loaders = document.querySelectorAll('.loader');
            loaders.forEach(loader => {
                loader.textContent = 'Error loading tasks. Please try again later.';
            });
        }

        // Refresh data every 5 minutes (300,000 milliseconds)
        setInterval(fetchAndRenderTasks, 300000);
    </script>
</body>
</html>
